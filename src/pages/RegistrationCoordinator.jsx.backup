import { useState, useEffect, useRef } from 'react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import { 
  Search, 
  Edit, 
  Trash2, 
  Check, 
  X, 
  Users,
  Calendar,
  DollarSign,
  Eye,
  UserPlus,
  Download,
  QrCode,
  Filter,
  RefreshCw
} from 'lucide-react'
import { uploadImage } from '../utils/imageUpload'
import { Html5QrcodeScanner } from 'html5-qrcode'
import { Html5QrcodeScanType } from 'html5-qrcode'

const RegistrationCoordinator = () => {
  // State variables
  const { isScannerCommittee } = useAuth()
  const [users, setUsers] = useState([])
  const [events, setEvents] = useState([])
  const [registrations, setRegistrations] = useState([])
  const [scanners, setScanners] = useState([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [activeTab, setActiveTab] = useState('users')
  const [showUserModal, setShowUserModal] = useState(false)
  const [showScannerModal, setShowScannerModal] = useState(false)
  const [editingUser, setEditingUser] = useState(null)
  const [editingScanner, setEditingScanner] = useState(null)
  const [selectedEvent, setSelectedEvent] = useState(null)
  const [colleges, setColleges] = useState([])
  const [fields, setFields] = useState([])
  const [paymentFilter, setPaymentFilter] = useState('all')
  const [workshops, setWorkshops] = useState([]);
  const [combos, setCombos] = useState([]);

  // Scanner view state (for scanner_committee role)
  const [scannerSelectedTargets, setScannerSelectedTargets] = useState([]) // [{id, type}]
  const [scannerAttendanceLogs, setScannerAttendanceLogs] = useState([])
  
  // QR Scanner state
  const [scanning, setScanning] = useState(false)
  const [showScanModal, setShowScanModal] = useState(false)
  const [scanResult, setScanResult] = useState(null)
  const qrScannerRef = useRef(null)
  
  // Single target selection for scanner (only one event/workshop at a time)
  const [selectedTarget, setSelectedTarget] = useState(null) // {id, type, name}
  
  // Form data
  const [userFormData, setUserFormData] = useState({
    name: '',
    email: '',
    phone: '',
    enrollment_number: '',
    college_id: '',
    semester: '',
    field_id: '',
    role: 'participant',
    photo_url: '',
    selected_tech_events: [],
    selected_non_tech_events: [],
    selected_workshops: [],
    selected_combos: [],
    transaction_id: '',
    amount_paid: ''
  })
  
  const [scannerFormData, setScannerFormData] = useState({
    name: '',
    email: '',
    phone: '',
    role: 'scanner_committee',
    college_id: '',
    semester: '',
    roll_number: '',
    photo_url: '',
    photo_file: null
  })

  // Fetch data on component mount
  useEffect(() => {
    const fetchAllData = async () => {
      try {
        await Promise.all([
          fetchUsers(),
          fetchEvents(),
          fetchColleges(),
          fetchFields(),
          fetchScanners(),
          fetchWorkshops(),
    fetchCombos()
        ]);
        // preload live list if scanner tab is default
        if (activeTab === 'attendance') {
          await refreshScannerParticipants()
        }
      } catch (error) {
        console.error('Error fetching initial data:', error);
      }
    };
    
    fetchAllData();
  }, [searchTerm, paymentFilter])

  // Handle URL-based navigation
  useEffect(() => {
    const path = window.location.pathname;
    if (path.includes('/users')) {
      setActiveTab('users');
    } else if (path.includes('/events')) {
      setActiveTab('events');
    } else if (path.includes('/attendance')) {
      setActiveTab('attendance');
      // when navigating to attendance, refresh live list
      setTimeout(() => {
        refreshScannerParticipants()
      }, 0)
    }
  }, [window.location.pathname]);

  // Real-time subscription for attendance updates
  useEffect(() => {
    if (activeTab === 'attendance' && selectedTarget) {
      const subscription = supabase
        .channel('attendance_updates')
        .on('postgres_changes', 
          { 
            event: '*', 
            schema: 'public', 
            table: 'attendance' 
          }, 
          (payload) => {
            console.log('Attendance update received:', payload);
            // Refresh the participants list when attendance changes
            refreshScannerParticipants();
          }
        )
        .subscribe();

      return () => {
        subscription.unsubscribe();
      };
    }
  }, [activeTab, selectedTarget]);

  // Debug selected target changes
  useEffect(() => {
    console.log('Selected target changed:', selectedTarget)
  }, [selectedTarget])

  // Fetch users with registrations
  const fetchUsers = async () => {
    try {
      setLoading(true)
      console.log('RegistrationCoordinator: Fetching users...')
      
      let query = supabase
        .from('users')
        .select('*, registrations(*)')
        .eq('role', 'participant')
        .order('created_at', { ascending: false })

      if (searchTerm) {
        query = query.or(`name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%,enrollment_number.ilike.%${searchTerm}%`)
      }

      const { data, error } = await query
      
      if (error) {
        console.error('Error fetching users:', error)
        return
      }
      
      // Fetch detailed registration data for each user
      const usersWithDetails = await Promise.all(
        (data || []).map(async (user) => {
          try {
            // Fetch all registrations for the user (including combo items)
            const { data: registrationDetails, error: regError } = await supabase
              .from('registrations')
              .select('*')
              .eq('user_id', user.id)
              .order('created_at', { ascending: false });
            
            if (regError) {
              console.error('Error fetching registration details for user:', user.id, regError);
              return {
                ...user,
                registrations: []
              };
            }
            
            return {
              ...user,
              registrations: registrationDetails || []
            };
          } catch (error) {
            console.error('Error fetching registration details for user:', user.id, error);
            return {
              ...user,
              registrations: []
            };
          }
        })
      );
      
      console.log('RegistrationCoordinator: Users fetched:', usersWithDetails.length)
      setUsers(usersWithDetails)
    } catch (error) {
      console.error('Error in fetchUsers:', error)
    } finally {
      setLoading(false)
    }
  }

  // Fetch events
  const fetchEvents = async () => {
    try {
      console.log('RegistrationCoordinator: Fetching events...');
      const { data: eventsData, error: eventsError } = await supabase
        .from('events')
        .select('*')
        .order('created_at', { ascending: false });

      if (eventsError) {
        console.error('Error fetching events:', eventsError);
        return;
      }

      if (!eventsData || eventsData.length === 0) {
        console.log('RegistrationCoordinator: No events found.');
        setEvents([]);
        return;
      }

      const eventIds = eventsData.map((e) => e.id);

      const { data: registrationsData, error: registrationsError } = await supabase
        .from('registrations')
        .select('*')
        .in('target_id', eventIds)
        .eq('target_type', 'event');

      if (registrationsError) {
        console.error('Error fetching event registrations:', registrationsError);
        const eventsWithEmptyRegistrations = eventsData.map(event => ({
          ...event,
          registrations: [],
        }));
        setEvents(eventsWithEmptyRegistrations);
        return;
      }

      const eventsWithRegistrations = eventsData.map(event => ({
        ...event,
        registrations: registrationsData.filter(r => r.target_id === event.id),
      }));

      console.log('RegistrationCoordinator: Events fetched:', eventsWithRegistrations.length);
      setEvents(eventsWithRegistrations);
    } catch (error) {
      console.error('Error in fetchEvents:', error);
    }
  };

  // Fetch colleges for dropdown
  const fetchColleges = async () => {
    try {
      const { data, error } = await supabase
        .from('colleges')
        .select('id, name')
        .order('name')
      
      if (error) {
        console.error('Error fetching colleges:', error)
        return
      }
      
      setColleges(data)
    } catch (error) {
      console.error('Error in fetchColleges:', error)
    }
  }

  // Fetch fields for dropdown
  const fetchFields = async () => {
    try {
      const { data, error } = await supabase
        .from('fields')
        .select('id, name')
        .order('name')
      
      if (error) {
        console.error('Error fetching fields:', error)
        return
      }
      
      setFields(data)
    } catch (error) {
      console.error('Error in fetchFields:', error)
    }
  }

  // Fetch scanner committee members
  const fetchScanners = async () => {
    try {
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('role', 'scanner_committee')
        .order('name')
      
      if (error) {
        console.error('Error fetching scanners:', error)
        return
      }
      
      setScanners(data)
    } catch (error) {
      console.error('Error in fetchScanners:', error)
    }
  }

  const fetchWorkshops = async () => {
    try {
      console.log('RegistrationCoordinator: Starting to fetch workshops...');
      const { data, error } = await supabase
        .from('workshops')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching workshops:', error);
        return;
      }

      if (!data || data.length === 0) {
        console.log('RegistrationCoordinator: No workshops found.');
        setWorkshops([]);
        return;
      }

      const workshopIds = data.map((w) => w.id);

      const { data: registrationsData, error: registrationsError } = await supabase
        .from('registrations')
        .select('*')
        .in('target_id', workshopIds)
        .eq('target_type', 'workshop');

      if (registrationsError) {
        console.error('Error fetching workshop registrations:', registrationsError);
        const workshopsWithEmptyRegistrations = data.map(workshop => ({
          ...workshop,
          registrations: [],
        }));
        setWorkshops(workshopsWithEmptyRegistrations);
        return;
      }

      const workshopsWithRegistrations = data.map(workshop => ({
        ...workshop,
        registrations: registrationsData.filter(r => r.target_id === workshop.id),
      }));
      
      console.log('RegistrationCoordinator: Workshops fetched:', workshopsWithRegistrations.length);
      console.log('RegistrationCoordinator: Workshops data:', workshopsWithRegistrations);
      setWorkshops(workshopsWithRegistrations);
    } catch (error) {
      console.error('Error in fetchWorkshops:', error);
    }
  };

  // Refresh live list for scanner panel
  const refreshScannerParticipants = async () => {
    try {
      if (!selectedTarget) {
        setScannerAttendanceLogs([])
        return
      }

      // Fetch approved registrations for selected target
      const { data: regs, error } = await supabase
        .from('registrations')
        .select('user_id, target_id, target_type, payment_status, users(name,email,phone), events(name), workshops(title)')
        .eq('target_id', selectedTarget.id)
        .eq('target_type', selectedTarget.type)
        .eq('payment_status', 'approved')

      if (error) throw error

      // For each registration, check if attendance exists
      const results = []
      for (const r of regs || []) {
        const { data: att } = await supabase
          .from('attendance')
          .select('scan_time')
          .eq('user_id', r.user_id)
          .eq('target_type', r.target_type)
          .eq('target_id', r.target_id)
          .limit(1)

        results.push({
          user_id: r.user_id,
          target_id: r.target_id,
          target_type: r.target_type,
          name: r.users?.name || 'User',
          email: r.users?.email || '',
          phone: r.users?.phone || '',
          attended: !!(att && att.length),
          time: att && att.length ? new Date(att[0].scan_time).toLocaleString() : null,
          targetName: r.target_type === 'event' ? (r.events?.name || 'Event') : (r.workshops?.title || 'Workshop')
        })
      }

      setScannerAttendanceLogs(results)
    } catch (e) {
      console.error('Error refreshing scanner participants:', e)
    }
  }

  // QR Code Scanner Functions
  const startScanning = () => {
    if (!selectedTarget) {
      alert('Please select one target (event/workshop) to scan for')
      return
    }

    console.log('Starting scanner with target:', selectedTarget)
    setShowScanModal(true)
    setScanning(true)

    // Initialize QR scanner after modal is rendered
    setTimeout(() => {
      try {
        // Clear any existing scanner
        if (qrScannerRef.current) {
          qrScannerRef.current.clear()
        }
        
        // Create new scanner instance with proper camera permissions
        qrScannerRef.current = new Html5QrcodeScanner(
          "qr-reader",
          { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
          },
          false
        )
        
        console.log('QR Scanner initialized, rendering...')
        qrScannerRef.current.render(onScanSuccess, onScanFailure)
        
        // Force camera permission request
        setTimeout(() => {
          const videoElement = document.querySelector('#qr-reader video')
          if (videoElement) {
            videoElement.play().catch(error => {
              console.error('Camera permission error:', error)
              setScanResult({
                success: false,
                message: 'Camera permission denied. Please allow camera access and try again.'
              })
            })
          }
        }, 1000)
        
      } catch (error) {
        console.error('Error initializing QR scanner:', error)
        setScanResult({
          success: false,
          message: 'Failed to initialize camera: ' + error.message
        })
      }
    }, 500) // Increased timeout to ensure modal is fully rendered
  }

  const stopScanning = () => {
    if (qrScannerRef.current) {
      qrScannerRef.current.clear()
      qrScannerRef.current = null
    }
    setScanning(false)
    setShowScanModal(false)
    setScanResult(null)
  }

  const onScanSuccess = async (decodedText, decodedResult) => {
    try {
      // Parse QR code data
      let qrData
      try {
        qrData = JSON.parse(decodedText)
      } catch {
        qrData = { user_id: decodedText }
      }

      const userId = qrData.user_id || qrData.userId
      if (!userId) {
        throw new Error('Invalid QR code format')
      }

      // Check if user has approved registration for selected target
      const { data: registrations, error } = await supabase
        .from('registrations')
        .select('*')
        .eq('user_id', userId)
        .eq('target_id', selectedTarget.id)
        .eq('target_type', selectedTarget.type)
        .eq('payment_status', 'approved')

      if (error) throw error

      if (!registrations || registrations.length === 0) {
        setScanResult({
          success: false,
          message: 'User not registered for selected target or payment not approved'
        })
        return
      }

      // Check if already attended
      const { data: existingAttendance } = await supabase
        .from('attendance')
        .select('*')
        .eq('user_id', userId)
        .eq('target_id', selectedTarget.id)
        .eq('target_type', selectedTarget.type)

      if (existingAttendance && existingAttendance.length > 0) {
        setScanResult({
          success: false,
          message: 'User already attended this target'
        })
        return
      }

      // Get current user for scanned_by
      const { data: { user: currentUser } } = await supabase.auth.getUser()
      const currentUserId = currentUser?.id

      // Record attendance for selected target
      const attendanceRecord = {
        user_id: userId,
        target_type: selectedTarget.type,
        target_id: selectedTarget.id,
        scanned_by: currentUserId,
        scan_time: new Date().toISOString()
      }

      const { error: attendanceError } = await supabase
        .from('attendance')
        .insert([attendanceRecord])

      if (attendanceError) throw attendanceError

      // Get user details for success message
      const { data: userData } = await supabase
        .from('users')
        .select('name, email')
        .eq('id', userId)
        .single()

      setScanResult({
        success: true,
        message: 'Attendance recorded successfully',
        user: userData?.name || 'User'
      })

      // Refresh the participants list
      await refreshScannerParticipants()

      // Stop scanning after successful scan
      setTimeout(() => {
        stopScanning()
      }, 2000)

    } catch (error) {
      console.error('Error processing scan:', error)
      setScanResult({
        success: false,
        message: 'Error processing scan: ' + error.message
      })
    }
  }

  const onScanFailure = (error) => {
    // Handle scan failure silently
    console.log('QR scan failed:', error)
  }

  const fetchCombos = async () => {
    try {
      const { data, error } = await supabase
        .from('combos')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching combos:', error);
        return;
      }

      // Fetch combo items for each combo
      const combosWithDetails = await Promise.all(
        (data || []).map(async (combo) => {
          try {
            const { data: comboItems } = await supabase
              .from('combo_items')
              .select('*')
              .eq('combo_id', combo.id)
              .order('position');

            // Fetch event/workshop details for each combo item
            const itemsWithDetails = await Promise.all(
              (comboItems || []).map(async (item) => {
                if (item.target_type === 'event') {
                  const { data: eventData } = await supabase
                    .from('events')
                    .select('id, name, price, category')
                    .eq('id', item.target_id)
                    .single();
                  return { ...item, event: eventData };
                } else if (item.target_type === 'workshop') {
                  const { data: workshopData } = await supabase
                    .from('workshops')
                    .select('id, title, fee')
                    .eq('id', item.target_id)
                    .single();
                  return { ...item, workshop: workshopData };
                }
                return item;
              })
            );

            return {
              ...combo,
              combo_items: itemsWithDetails
            };
          } catch (error) {
            console.error('Error fetching combo details:', error);
            return { ...combo, combo_items: [] };
          }
        })
      );

      setCombos(combosWithDetails);
    } catch (error) {
      console.error('Error in fetchCombos:', error);
    }
  };

  // Calculate total price for selected items
  const calculateTotalPrice = () => {
    let total = 0;
    
    // Get all combo items to avoid double-counting
    const comboItemIds = new Set();
    userFormData.selected_combos.forEach(comboId => {
      const combo = combos.find(c => c.id === comboId);
      if (combo && combo.combo_items) {
        combo.combo_items.forEach(item => {
          comboItemIds.add(item.target_id);
        });
      }
    });
    
    // Add prices for selected tech events (only if not part of selected combos)
    userFormData.selected_tech_events.forEach(eventId => {
      if (!comboItemIds.has(eventId)) {
        const event = events.find(e => e.id === eventId);
        if (event) total += event.price || 0;
      }
    });
    
    // Add prices for selected non-tech events (only if not part of selected combos)
    userFormData.selected_non_tech_events.forEach(eventId => {
      if (!comboItemIds.has(eventId)) {
        const event = events.find(e => e.id === eventId);
        if (event) total += event.price || 0;
      }
    });
    
    // Add prices for selected workshops (only if not part of selected combos)
    userFormData.selected_workshops.forEach(workshopId => {
      if (!comboItemIds.has(workshopId)) {
        const workshop = workshops.find(w => w.id === workshopId);
        if (workshop) total += workshop.fee || 0;
      }
    });
    
    // Add prices for selected combos
    userFormData.selected_combos.forEach(comboId => {
      const combo = combos.find(c => c.id === comboId);
      if (combo) total += combo.price || 0;
    });
    
    return total;
  };

  // Handle combo selection and show combo details
  const handleComboSelection = (comboId) => {
    const combo = combos.find(c => c.id === comboId);
    if (combo) {
      console.log('Selected combo:', combo.name);
      console.log('Combo items:', combo.combo_items);
    }
  };

  // State for validation
  const [validationErrors, setValidationErrors] = useState({
    email: '',
    phone: '',
    transaction_id: ''
  });
  const [isValidating, setIsValidating] = useState({
    email: false,
    phone: false,
    transaction_id: false
  });

  // Handle user form input changes
  const handleUserFormChange = (e) => {
    const { name, value } = e.target
    
    setUserFormData(prev => ({
      ...prev,
      [name]: value
    }));

    // Clear validation error when user starts typing
    if (validationErrors[name]) {
      setValidationErrors(prev => ({
        ...prev,
        [name]: ''
      }));
    }

    // Real-time validation for email, phone, and transaction_id
    if (name === 'email' && value) {
      validateEmail(value);
    } else if (name === 'phone' && value) {
      validatePhone(value);
    } else if (name === 'transaction_id' && value) {
      validateTransactionId(value);
    }
  }

  // Handle checkbox changes for events
  const handleCheckboxChange = (fieldName, itemId, checked) => {
    setUserFormData(prev => {
      const currentArray = prev[fieldName] || [];
      let newArray;
      
      if (checked) {
        newArray = [...currentArray, itemId];
      } else {
        newArray = currentArray.filter(id => id !== itemId);
      }
      
      return {
        ...prev,
        [fieldName]: newArray
      };
    });
  }

  // Handle combo selection with automatic event removal
  const handleComboCheckboxChange = (comboId, checked) => {
    setUserFormData(prev => {
      const combo = combos.find(c => c.id === comboId);
      if (!combo) return prev;

      let newFormData = { ...prev };
      
      if (checked) {
        // Add combo to selected combos
        newFormData.selected_combos = [...prev.selected_combos, comboId];
        
        // Remove individual events that are part of this combo
        const eventsToRemove = [];
        const workshopsToRemove = [];
        
        combo.combo_items?.forEach(item => {
          if (item.target_type === 'event') {
            eventsToRemove.push(item.target_id);
          } else if (item.target_type === 'workshop') {
            workshopsToRemove.push(item.target_id);
          }
        });
        
        // Remove from tech events
        newFormData.selected_tech_events = prev.selected_tech_events.filter(
          eventId => !eventsToRemove.includes(eventId)
        );
        
        // Remove from non-tech events
        newFormData.selected_non_tech_events = prev.selected_non_tech_events.filter(
          eventId => !eventsToRemove.includes(eventId)
        );
        
        // Remove from workshops
        newFormData.selected_workshops = prev.selected_workshops.filter(
          workshopId => !workshopsToRemove.includes(workshopId)
        );
        
      } else {
        // Remove combo from selected combos
        newFormData.selected_combos = prev.selected_combos.filter(id => id !== comboId);
      }
      
      return newFormData;
    });
  }

  // Check if an event is part of any selected combo
  const isEventInSelectedCombo = (eventId) => {
    return userFormData.selected_combos.some(comboId => {
      const combo = combos.find(c => c.id === comboId);
      return combo?.combo_items?.some(item => 
        item.target_type === 'event' && item.target_id === eventId
      );
    });
  }

  // Check if a workshop is part of any selected combo
  const isWorkshopInSelectedCombo = (workshopId) => {
    return userFormData.selected_combos.some(comboId => {
      const combo = combos.find(c => c.id === comboId);
      return combo?.combo_items?.some(item => 
        item.target_type === 'workshop' && item.target_id === workshopId
      );
    });
  }

  // Validate email uniqueness
  const validateEmail = async (email) => {
    if (!email) return;
    
    setIsValidating(prev => ({ ...prev, email: true }));
    
    try {
      const { data, error } = await supabase
        .from('users')
        .select('id, email')
        .eq('email', email)
        .neq('id', editingUser?.id || '00000000-0000-0000-0000-000000000000'); // Exclude current user if editing
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        setValidationErrors(prev => ({
          ...prev,
          email: 'This email is already registered'
        }));
      } else {
        setValidationErrors(prev => ({
          ...prev,
          email: ''
        }));
      }
    } catch (error) {
      console.error('Error validating email:', error);
    } finally {
      setIsValidating(prev => ({ ...prev, email: false }));
    }
  };

  // Validate phone uniqueness
  const validatePhone = async (phone) => {
    if (!phone) return;
    
    setIsValidating(prev => ({ ...prev, phone: true }));
    
    try {
      const { data, error } = await supabase
        .from('users')
        .select('id, phone')
        .eq('phone', phone)
        .neq('id', editingUser?.id || '00000000-0000-0000-0000-000000000000'); // Exclude current user if editing
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        setValidationErrors(prev => ({
          ...prev,
          phone: 'This phone number is already registered'
        }));
      } else {
        setValidationErrors(prev => ({
          ...prev,
          phone: ''
        }));
      }
    } catch (error) {
      console.error('Error validating phone:', error);
    } finally {
      setIsValidating(prev => ({ ...prev, phone: false }));
    }
  };

  // Validate transaction ID uniqueness
  const validateTransactionId = async (transactionId) => {
    if (!transactionId) return;
    
    setIsValidating(prev => ({ ...prev, transaction_id: true }));
    
    try {
      const { data, error } = await supabase
        .from('registrations')
        .select('id, transaction_id, user_id')
        .eq('transaction_id', transactionId)
        .neq('user_id', editingUser?.id || '00000000-0000-0000-0000-000000000000'); // Exclude current user if editing
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        setValidationErrors(prev => ({
          ...prev,
          transaction_id: 'This transaction ID is already used'
        }));
      } else {
        setValidationErrors(prev => ({
          ...prev,
          transaction_id: ''
        }));
      }
    } catch (error) {
      console.error('Error validating transaction ID:', error);
    } finally {
      setIsValidating(prev => ({ ...prev, transaction_id: false }));
    }
  };

  // Handle multiselect change with better UX
  const handleMultiSelectChange = (fieldName, selectedValues) => {
    setUserFormData(prev => ({
      ...prev,
      [fieldName]: selectedValues
    }));
    
    // If combo is selected, log the details
    if (fieldName === 'selected_combos') {
      selectedValues.forEach(comboId => handleComboSelection(comboId));
    }
  }

  // Handle scanner form input changes
  const handleScannerFormChange = (e) => {
    const { name, value } = e.target
    setScannerFormData({
      ...scannerFormData,
      [name]: value
    })
  }

  // Handle scanner photo upload
  const handleScannerPhotoUpload = async (e) => {
    const file = e.target.files[0]
    if (!file) return

    try {
      const photoUrl = await uploadImage(file, 'profile-photos')
      setScannerFormData({
        ...scannerFormData,
        photo_url: photoUrl
      })
    } catch (error) {
      console.error('Error uploading scanner photo:', error)
    }
  }

  // Handle user photo upload
  const handlePhotoUpload = async (e) => {
    const file = e.target.files[0]
    if (!file) return

    try {
      const photoUrl = await uploadImage(file, 'profile-photos')
      setUserFormData({
        ...userFormData,
        photo_url: photoUrl
      })
    } catch (error) {
      console.error('Error uploading photo:', error)
    }
  }

  // Open user modal for editing
  const handleEditUser = async (user) => {
    setEditingUser(user)
    
    // Refresh events, workshops, and combos data to ensure we have the latest prices
    try {
      await Promise.all([
        fetchEvents(),
        fetchWorkshops(),
        fetchCombos()
      ]);
    } catch (error) {
      console.error('Error refreshing data:', error);
    }
    
    // Fetch user's registrations to populate the form
    try {
      // Fetch all registrations for the user (including combo items)
      const { data: registrations, error } = await supabase
        .from('registrations')
        .select('*')
        .eq('user_id', user.id);
      
      if (error) {
        console.error('Error fetching user registrations:', error);
        // Set empty form data if fetch fails
    setUserFormData({
      name: user.name || '',
      email: user.email || '',
      phone: user.phone || '',
      enrollment_number: user.enrollment_number || '',
      college_id: user.college_id || '',
      semester: user.semester || '',
      field_id: user.field_id || '',
      role: user.role || 'participant',
          photo_url: user.photo_url || '',
          selected_tech_events: [],
          selected_non_tech_events: [],
          selected_workshops: [],
          selected_combos: [],
          transaction_id: '',
          amount_paid: ''
        });
      } else {
        // Process registrations and categorize them
        const selectedTechEvents = [];
        const selectedNonTechEvents = [];
        const selectedWorkshops = [];
        const selectedCombos = [];
        let transactionId = '';
        let amountPaid = 0;
        
        if (registrations) {
          registrations.forEach(reg => {
            if (reg.target_type === 'event') {
              // We'll determine category based on the events array we already have
              const event = events.find(e => e.id === reg.target_id);
              if (event) {
                if (event.category === 'tech') {
                  selectedTechEvents.push(reg.target_id);
                } else {
                  selectedNonTechEvents.push(reg.target_id);
                }
              }
            } else if (reg.target_type === 'workshop') {
              selectedWorkshops.push(reg.target_id);
            } else if (reg.target_type === 'combo') {
              selectedCombos.push(reg.target_id);
            }
            
            if (!transactionId && reg.transaction_id) {
              transactionId = reg.transaction_id;
            }
            if (reg.amount_paid > 0) {
              amountPaid += reg.amount_paid;
            }
          });
          
          // Now we need to handle the case where combo items are registered individually
          // If a user has combo registrations, we should also check for individual item registrations
          // and mark them as part of combos (disabled in UI)
          const comboItemIds = new Set();
          userFormData.selected_combos.forEach(comboId => {
            const combo = combos.find(c => c.id === comboId);
            if (combo && combo.combo_items) {
              combo.combo_items.forEach(item => {
                comboItemIds.add(item.target_id);
              });
            }
          });
          
          // Remove combo items from individual selections to avoid duplication
          // This ensures the UI shows the correct state
          userFormData.selected_tech_events = userFormData.selected_tech_events.filter(id => !comboItemIds.has(id));
          userFormData.selected_non_tech_events = userFormData.selected_non_tech_events.filter(id => !comboItemIds.has(id));
          userFormData.selected_workshops = userFormData.selected_workshops.filter(id => !comboItemIds.has(id));
        }
        
        setUserFormData({
          name: user.name || '',
          email: user.email || '',
          phone: user.phone || '',
          enrollment_number: user.enrollment_number || '',
          college_id: user.college_id || '',
          semester: user.semester || '',
          field_id: user.field_id || '',
          role: user.role || 'participant',
          photo_url: user.photo_url || '',
          selected_tech_events: selectedTechEvents,
          selected_non_tech_events: selectedNonTechEvents,
          selected_workshops: selectedWorkshops,
          selected_combos: selectedCombos,
          transaction_id: transactionId,
          amount_paid: amountPaid.toString()
        });
      }
    } catch (error) {
      console.error('Error in handleEditUser:', error);
      // Fallback to basic user data if registration fetch fails
      setUserFormData({
        name: user.name || '',
        email: user.email || '',
        phone: user.phone || '',
        enrollment_number: user.enrollment_number || '',
        college_id: user.college_id || '',
        semester: user.semester || '',
        field_id: user.field_id || '',
        role: user.role || 'participant',
        photo_url: user.photo_url || '',
        selected_tech_events: [],
        selected_non_tech_events: [],
        selected_workshops: [],
        selected_combos: [],
        transaction_id: '',
        amount_paid: ''
      });
    }
    
    setShowUserModal(true);
  }

  // Open scanner modal for editing
  const handleEditScanner = (scanner) => {
    setEditingScanner(scanner)
    setScannerFormData({
      name: scanner.name || '',
      email: scanner.email || '',
      phone: scanner.phone || '',
      role: 'scanner_committee',
      college_id: scanner.college_id || '',
      semester: scanner.semester || '',
      roll_number: (scanner.metadata && scanner.metadata.roll_number) || '',
      photo_url: scanner.photo_url || ''
    })
    setShowScannerModal(true)
  }

  // Submit user form
  const handleUserSubmit = async (e) => {
    e.preventDefault()
     
     // Check for validation errors
     if (validationErrors.email || validationErrors.phone || validationErrors.transaction_id) {
       alert('Please fix the validation errors before submitting.');
       return;
     }
     
     // Check if any validation is still in progress
     if (isValidating.email || isValidating.phone || isValidating.transaction_id) {
       alert('Please wait for validation to complete.');
       return;
     }
     
     // Validate that total amount matches selected items
     const calculatedTotal = calculateTotalPrice();
     const enteredAmount = parseFloat(userFormData.amount_paid) || 0;
     
     if (Math.abs(calculatedTotal - enteredAmount) > 0.01) { // Allow small rounding differences
       alert(`Total amount paid (₹${enteredAmount.toFixed(2)}) does not match the sum of selected items (₹${calculatedTotal.toFixed(2)}). Please adjust the amount or selections.`);
       return;
     }
     
           try {
       let userId;
       
      if (editingUser) {
        // Update existing user
        const { error } = await supabase
          .from('users')
          .update({
            name: userFormData.name,
            email: userFormData.email,
            phone: userFormData.phone,
            enrollment_number: userFormData.enrollment_number,
            college_id: userFormData.college_id || null,
            semester: userFormData.semester,
            field_id: userFormData.field_id || null,
            photo_url: userFormData.photo_url,
            updated_at: new Date()
          })
          .eq('id', editingUser.id)
        
        if (error) throw error
         userId = editingUser.id
        console.log('User updated successfully')
      } else {
        // Create new user
         const { data, error } = await supabase
          .from('users')
          .insert([
            {
              name: userFormData.name,
              email: userFormData.email,
              phone: userFormData.phone,
              enrollment_number: userFormData.enrollment_number,
              college_id: userFormData.college_id || null,
              semester: userFormData.semester,
              field_id: userFormData.field_id || null,
              role: 'participant',
              photo_url: userFormData.photo_url
            }
          ])
           .select()
        
        if (error) throw error
         userId = data[0].id
        console.log('User created successfully')
      }
       
       // Handle registrations
       if (userId) {
         // Delete existing registrations for this user (if editing)
         if (editingUser) {
           const { error: deleteError } = await supabase
             .from('registrations')
             .delete()
             .eq('user_id', userId)
           
           if (deleteError) {
             console.error('Error deleting existing registrations:', deleteError)
           }
         }
         
                   // Create new registrations for selected items
          const registrationsToInsert = [];
          
          // Use actual event prices, not proportional amounts
          // Add tech events with actual price
          userFormData.selected_tech_events.forEach(eventId => {
            const event = events.find(e => e.id === eventId);
            const eventPrice = event?.price || 0;
            
            registrationsToInsert.push({
              user_id: userId,
              target_type: 'event',
              target_id: eventId,
              transaction_id: userFormData.transaction_id || null,
              amount_paid: eventPrice, // Use actual event price
              payment_status: 'pending'
            });
          });
          
          // Add non-tech events with actual price
          userFormData.selected_non_tech_events.forEach(eventId => {
            const event = events.find(e => e.id === eventId);
            const eventPrice = event?.price || 0;
            
            registrationsToInsert.push({
              user_id: userId,
              target_type: 'event',
              target_id: eventId,
              transaction_id: userFormData.transaction_id || null,
              amount_paid: eventPrice, // Use actual event price
              payment_status: 'pending'
            });
          });
          
          // Add workshops with actual fee
          userFormData.selected_workshops.forEach(workshopId => {
            const workshop = workshops.find(w => w.id === workshopId);
            const workshopFee = workshop?.fee || 0;
            
            registrationsToInsert.push({
              user_id: userId,
              target_type: 'workshop',
              target_id: workshopId,
              transaction_id: userFormData.transaction_id || null,
              amount_paid: workshopFee, // Use actual workshop fee
              payment_status: 'pending'
            });
          });
          
          // Add combos with combo price AND individual item registrations for participant tracking
          userFormData.selected_combos.forEach(comboId => {
            const combo = combos.find(c => c.id === comboId);
            if (!combo) return;
            
            // First, add the main combo registration
            registrationsToInsert.push({
              user_id: userId,
              target_type: 'combo',
              target_id: comboId,
              transaction_id: userFormData.transaction_id || null,
              amount_paid: combo.price || 0, // Use combo price
              payment_status: 'pending'
            });
            
            // Then, add individual registrations for each combo item (with 0 amount_paid to avoid double-charging)
            // This ensures participants are visible in individual event/workshop lists
            if (combo.combo_items) {
              combo.combo_items.forEach(comboItem => {
                if (comboItem.target_type === 'event') {
                  registrationsToInsert.push({
                    user_id: userId,
                    target_type: 'event',
                    target_id: comboItem.target_id,
                    transaction_id: userFormData.transaction_id || null,
                    amount_paid: 0, // 0 amount since already paid via combo
                    payment_status: 'pending',
                    parent_registration_id: null // Link to combo registration if needed
                  });
                } else if (comboItem.target_type === 'workshop') {
                  registrationsToInsert.push({
                    user_id: userId,
                    target_type: 'workshop',
                    target_id: comboItem.target_id,
                    transaction_id: userFormData.transaction_id || null,
                    amount_paid: 0, // 0 amount since already paid via combo
                    payment_status: 'pending',
                    parent_registration_id: null // Link to combo registration if needed
                  });
                }
              });
            }
          });
         
         // Insert registrations if any
         if (registrationsToInsert.length > 0) {
           const { error: regError } = await supabase
             .from('registrations')
             .insert(registrationsToInsert)
           
           if (regError) {
             console.error('Error creating registrations:', regError)
           } else {
             console.log('Registrations created successfully')
           }
         }
      }
      
      // Reset form and close modal
      setUserFormData({
        name: '',
        email: '',
        phone: '',
        enrollment_number: '',
        college_id: '',
        semester: '',
        field_id: '',
        role: 'participant',
         photo_url: '',
         selected_tech_events: [],
         selected_non_tech_events: [],
         selected_workshops: [],
         selected_combos: [],
         transaction_id: '',
         amount_paid: ''
       })
       // Clear validation errors
       setValidationErrors({
         email: '',
         phone: '',
         transaction_id: ''
      })
      setEditingUser(null)
      setShowUserModal(false)
      fetchUsers()
    } catch (error) {
      console.error('Error submitting user form:', error)
    }
  }

  // Submit scanner form
  const handleScannerSubmit = async (e) => {
    e.preventDefault()
    
    try {
      if (editingScanner) {
        // Update existing scanner
        const { error } = await supabase
          .from('users')
          .update({
            name: scannerFormData.name,
            email: scannerFormData.email,
            phone: scannerFormData.phone,
            role: 'scanner_committee',
            college_id: scannerFormData.college_id,
            semester: scannerFormData.semester,
            photo_url: scannerFormData.photo_url,
            metadata: {
              ...(editingScanner?.metadata || {}),
              roll_number: scannerFormData.roll_number || null
            },
            updated_at: new Date()
          })
          .eq('id', editingScanner.id)
        
        if (error) throw error
        console.log('Scanner updated successfully')
      } else {
        // Create new scanner
        const { error } = await supabase
          .from('users')
          .insert([
            {
              name: scannerFormData.name,
              email: scannerFormData.email,
              phone: scannerFormData.phone,
              role: 'scanner_committee',
              college_id: scannerFormData.college_id,
              semester: scannerFormData.semester,
              photo_url: scannerFormData.photo_url,
              metadata: {
                roll_number: scannerFormData.roll_number || null
              }
            }
          ])
        
        if (error) throw error
        console.log('Scanner created successfully')
      }
      
      // Reset form and close modal
      setScannerFormData({
        name: '',
        email: '',
        phone: '',
                        role: 'scanner_committee',
                        college_id: '',
                        semester: '',
                        roll_number: '',
                        photo_url: '',
                        photo_file: null
      })
      setEditingScanner(null)
      setShowScannerModal(false)
      fetchScanners()
    } catch (error) {
      console.error('Error submitting scanner form:', error)
    }
  }

  // Delete user
  const handleDeleteUser = async (userId) => {
    if (!confirm('Are you sure you want to delete this user?')) return
    
    try {
      const { error } = await supabase
        .from('users')
        .delete()
        .eq('id', userId)
      
      if (error) throw error
      console.log('User deleted successfully')
      fetchUsers()
    } catch (error) {
      console.error('Error deleting user:', error)
    }
  }

  // Delete scanner
  const handleDeleteScanner = async (scannerId) => {
    if (!confirm('Are you sure you want to delete this scanner?')) return
    
    try {
      const { error } = await supabase
        .from('users')
        .delete()
        .eq('id', scannerId)
      
      if (error) throw error
      console.log('Scanner deleted successfully')
      fetchScanners()
    } catch (error) {
      console.error('Error deleting scanner:', error)
    }
  }

  // Update payment status
  const handleUpdatePaymentStatus = async (registrationId, status) => {
    try {
      // First, get the registration details to check if it's a combo
      const { data: registration, error: fetchError } = await supabase
        .from('registrations')
        .select('*')
        .eq('id', registrationId)
        .single()
      
      if (fetchError) throw fetchError
      
      // Update the main registration
      const { error: updateError } = await supabase
        .from('registrations')
        .update({ payment_status: status, updated_at: new Date() })
        .eq('id', registrationId)
      
      if (updateError) throw updateError
      
      // If this is a combo registration, also update all related individual registrations
      if (registration.target_type === 'combo') {
        const combo = combos.find(c => c.id === registration.target_id)
        if (combo && combo.combo_items) {
          // Get all combo item IDs
          const comboItemIds = combo.combo_items.map(item => item.target_id)
          console.log('Combo items to update:', comboItemIds)
          console.log('User ID:', registration.user_id)
          
          // Update all individual registrations for combo items
          // We need to update both events and workshops separately since Supabase doesn't support OR with .eq()
          const { error: eventUpdateError } = await supabase
            .from('registrations')
            .update({ payment_status: status, updated_at: new Date() })
            .in('target_id', comboItemIds)
            .eq('user_id', registration.user_id)
            .eq('target_type', 'event')
          
          const { error: workshopUpdateError } = await supabase
            .from('registrations')
            .update({ payment_status: status, updated_at: new Date() })
            .in('target_id', comboItemIds)
            .eq('user_id', registration.user_id)
            .eq('target_type', 'workshop')
          
          if (eventUpdateError) {
            console.warn('Warning: Could not update event registrations:', eventUpdateError)
          } else {
            console.log('Successfully updated event registrations for combo items')
          }
          if (workshopUpdateError) {
            console.warn('Warning: Could not update workshop registrations:', workshopUpdateError)
          } else {
            console.log('Successfully updated workshop registrations for combo items')
          }
        }
      }
      
      console.log(`Payment status updated to ${status}`)
      fetchUsers()
    } catch (error) {
      console.error('Error updating payment status:', error)
    }
  }

  // View event participants
  const handleViewEventParticipants = async (eventId) => {
    try {
      setLoading(true)
      
      // Get direct registrations for this event
      const { data: directRegistrations, error: directError } = await supabase
        .from('registrations')
        .select('*, users(*)')
        .eq('target_type', 'event')
        .eq('target_id', eventId)
      
      if (directError) throw directError
      
      // Get all combo registrations
      const { data: comboRegistrations, error: comboError } = await supabase
        .from('registrations')
        .select('*, users(*)')
        .eq('target_type', 'combo')
      
      if (comboError) throw comboError
      
      // Get combo items to find which combos include this event
      const { data: comboItems, error: itemsError } = await supabase
        .from('combo_items')
        .select('*')
        .eq('target_type', 'event')
        .eq('target_id', eventId)
      
      if (itemsError) throw itemsError
      
      // Find combo IDs that include this event
      const relevantComboIds = comboItems.map(item => item.combo_id)
      
      console.log('Debug - Event ID:', eventId)
      console.log('Debug - Combo items found:', comboItems)
      console.log('Debug - Relevant combo IDs:', relevantComboIds)
      console.log('Debug - All combo registrations:', comboRegistrations)
      
      // Filter combo registrations to only include those that have this event
      const relevantComboRegistrations = comboRegistrations.filter(reg => 
        relevantComboIds.includes(reg.target_id)
      )
      
      console.log('Debug - Relevant combo registrations:', relevantComboRegistrations)
      console.log('Debug - Direct registrations:', directRegistrations)
      
      // Add registration type to each registration
      const directWithType = directRegistrations.map(reg => ({ ...reg, registrationType: 'Direct' }))
      const comboWithType = relevantComboRegistrations.map(reg => ({ ...reg, registrationType: 'Combo' }))
      
      // Combine both direct and combo registrations
      const allRegistrations = [...directWithType, ...comboWithType]
      
      // Remove duplicates based on user_id (keep the first occurrence)
      const uniqueRegistrations = allRegistrations.filter((reg, index, self) => 
        index === self.findIndex(r => r.user_id === reg.user_id)
      )
      
      setRegistrations(uniqueRegistrations)
      setSelectedEvent(events.find(e => e.id === eventId))
      setActiveTab('eventParticipants')
    } catch (error) {
      console.error('Error fetching event participants:', error)
    } finally {
      setLoading(false)
    }
  }

  // View workshop participants
  const handleViewWorkshopParticipants = async (workshopId) => {
    try {
      setLoading(true)
      
      // Get direct registrations for this workshop
      const { data: directRegistrations, error: directError } = await supabase
        .from('registrations')
        .select('*, users(*)')
        .eq('target_type', 'workshop')
        .eq('target_id', workshopId)
      
      if (directError) throw directError
      
      // Get all combo registrations
      const { data: comboRegistrations, error: comboError } = await supabase
        .from('registrations')
        .select('*, users(*)')
        .eq('target_type', 'combo')
      
      if (comboError) throw comboError
      
      // Get combo items to find which combos include this workshop
      const { data: comboItems, error: itemsError } = await supabase
        .from('combo_items')
        .select('*')
        .eq('target_type', 'workshop')
        .eq('target_id', workshopId)
      
      if (itemsError) throw itemsError
      
      // Find combo IDs that include this workshop
      const relevantComboIds = comboItems.map(item => item.combo_id)
      
      console.log('Debug - Workshop ID:', workshopId)
      console.log('Debug - Workshop combo items found:', comboItems)
      console.log('Debug - Workshop relevant combo IDs:', relevantComboIds)
      console.log('Debug - Workshop all combo registrations:', comboRegistrations)
      
      // Filter combo registrations to only include those that have this workshop
      const relevantComboRegistrations = comboRegistrations.filter(reg => 
        relevantComboIds.includes(reg.target_id)
      )
      
      console.log('Debug - Workshop relevant combo registrations:', relevantComboRegistrations)
      console.log('Debug - Workshop direct registrations:', directRegistrations)
      
      // Add registration type to each registration
      const directWithType = directRegistrations.map(reg => ({ ...reg, registrationType: 'Direct' }))
      const comboWithType = relevantComboRegistrations.map(reg => ({ ...reg, registrationType: 'Combo' }))
      
      // Combine both direct and combo registrations
      const allRegistrations = [...directWithType, ...comboWithType]
      
      // Remove duplicates based on user_id (keep the first occurrence)
      const uniqueRegistrations = allRegistrations.filter((reg, index, self) => 
        index === self.findIndex(r => r.user_id === reg.user_id)
      )
      
      setRegistrations(uniqueRegistrations)
      setSelectedEvent(workshops.find(w => w.id === workshopId))
      setActiveTab('eventParticipants')
    } catch (error) {
      console.error('Error fetching workshop participants:', error)
    } finally {
      setLoading(false)
    }
  }

  // Export participants as CSV
  const handleExportParticipants = () => {
    try {
      let csvContent = 'Name,Email,Phone,Enrollment Number,College,Payment Status\n'
      
      registrations.forEach(reg => {
        const user = reg.users
        const college = colleges.find(c => c.id === user.college_id)?.name || ''
        csvContent += `"${user.name}","${user.email}","${user.phone || ''}","${user.enrollment_number || ''}","${college}","${reg.payment_status}"\n`
      })
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.setAttribute('href', url)
      link.setAttribute('download', `${selectedEvent.name}-participants.csv`)
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    } catch (error) {
      console.error('Error exporting participants:', error)
    }
  }

  // Test function to check combo data
  const testComboData = async () => {
    try {
      console.log('=== TESTING COMBO DATA ===')
      
      // Check combo_items table
      const { data: comboItems, error: itemsError } = await supabase
        .from('combo_items')
        .select('*')
      
      console.log('All combo items:', comboItems)
      console.log('Combo items error:', itemsError)
      
      // Check combo registrations
      const { data: comboRegs, error: regsError } = await supabase
        .from('registrations')
        .select('*, users(*)')
        .eq('target_type', 'combo')
      
      console.log('All combo registrations:', comboRegs)
      console.log('Combo registrations error:', regsError)
      
      // Check combos table
      const { data: combos, error: combosError } = await supabase
        .from('combos')
        .select('*')
      
      console.log('All combos:', combos)
      console.log('Combos error:', combosError)
      
    } catch (error) {
      console.error('Error testing combo data:', error)
    }
  }

  // Filter users by payment status
  const filteredUsers = users.filter(user => {
    if (paymentFilter === 'all') return true
    
    const hasRegistrations = user.registrations && user.registrations.length > 0
    if (!hasRegistrations) return false
    
    return user.registrations.some(reg => reg.payment_status === paymentFilter)
  })

  return (
    <>
      <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <div className="flex space-x-2">
          {activeTab === 'users' && (
            <button
               onClick={async () => {
                 // Refresh data to ensure we have latest prices
                 try {
                   await Promise.all([
                     fetchEvents(),
                     fetchWorkshops(),
                     fetchCombos()
                   ]);
                 } catch (error) {
                   console.error('Error refreshing data:', error);
                 }
                 setShowUserModal(true);
               }}
              className="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
              <UserPlus className="-ml-1 mr-2 h-5 w-5" />
              Add User
            </button>
          )}
          {activeTab === 'eventParticipants' && (
            <>
              <button
                onClick={() => setActiveTab('events')}
                className="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
              >
                <Calendar className="-ml-1 mr-2 h-5 w-5" />
                Back to Events
              </button>
              <button
                onClick={handleExportParticipants}
                className="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
              >
                <Download className="-ml-1 mr-2 h-5 w-5" />
                Export CSV
              </button>
              <button
                onClick={testComboData}
                className="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
              >
                Test Combo Data
              </button>
            </>
          )}
        </div>
      </div>

      {/* Tabs */}
      <div className="border-b border-gray-200 dark:border-gray-700 mb-6">
        <nav className="-mb-px flex space-x-8">
          {!isScannerCommittee && (
          <button
             onClick={() => {
               setActiveTab('users');
               window.history.pushState({}, '', '/registration-committee/users');
             }}
            className={`${activeTab === 'users' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}
          >
            <Users className="inline-block mr-2 h-5 w-5" />
            User Management
          </button>
          )}
          {!isScannerCommittee && (
          <button
             onClick={() => {
               setActiveTab('events');
               window.history.pushState({}, '', '/registration-committee/events');
             }}
            className={`${activeTab === 'events' || activeTab === 'eventParticipants' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}
          >
            <Calendar className="inline-block mr-2 h-5 w-5" />
            Event Management
          </button>
          )}
          <button
             onClick={() => {
               setActiveTab('attendance');
               window.history.pushState({}, '', '/registration-committee/attendance');
             }}
            className={`${activeTab === 'attendance' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}
          >
            <QrCode className="inline-block mr-2 h-5 w-5" />
            {isScannerCommittee ? 'Scanner' : 'Attendance Management'}
          </button>
        </nav>
      </div>

      {/* Search and Filter */}
      {!isScannerCommittee && (activeTab === 'users' || activeTab === 'events') && (
        <div className="flex flex-col md:flex-row justify-between mb-6 space-y-4 md:space-y-0">
          <div className="relative w-full md:w-64">
            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <Search className="h-5 w-5 text-gray-400" />
            </div>
            <input
              type="text"
              placeholder={`Search ${activeTab === 'users' ? 'users' : 'events'}...`}
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md w-full focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:text-white"
            />
          </div>
          
          {activeTab === 'users' && (
            <div className="flex items-center space-x-2">
              <Filter className="h-5 w-5 text-gray-400" />
              <select
                value={paymentFilter}
                onChange={(e) => setPaymentFilter(e.target.value)}
                className="border border-gray-300 dark:border-gray-600 rounded-md py-2 pl-3 pr-10 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:text-white"
              >
                <option value="all">All Payments</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="declined">Declined</option>
                <option value="not_required">Not Required</option>
              </select>
              <button
                 onClick={async () => {
                   try {
                     await Promise.all([
                       fetchUsers(),
                       fetchEvents(),
                       fetchWorkshops(),
                       fetchCombos()
                     ]);
                   } catch (error) {
                     console.error('Error refreshing data:', error);
                   }
                 }}
                className="p-2 rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
                 title="Refresh All Data"
              >
                <RefreshCw className="h-5 w-5" />
              </button>
            </div>
          )}
        </div>
      )}

      {/* Content based on active tab */}
      {loading ? (
        <div className="flex justify-center items-center h-64">
          <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
        </div>
      ) : (
        <>
          {/* User Management Tab */}
          {activeTab === 'users' && (
            <div className="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-md">
              <ul className="divide-y divide-gray-200 dark:divide-gray-700">
                {filteredUsers.length > 0 ? (
                  filteredUsers.map(user => (
                    <li key={user.id} className="px-6 py-4">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <div className="flex-shrink-0 h-10 w-10">
                            {user.photo_url ? (
                              <img
                                className="h-10 w-10 rounded-full object-cover"
                                src={user.photo_url}
                                alt={user.name}
                              />
                            ) : (
                              <div className="h-10 w-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
                                <span className="text-gray-600 dark:text-gray-300 text-sm font-medium">
                                  {user.name.charAt(0).toUpperCase()}
                                </span>
                              </div>
                            )}
                          </div>
                          <div className="ml-4">
                            <div className="text-sm font-medium text-gray-900 dark:text-white">
                              {user.name}
                            </div>
                            <div className="text-sm text-gray-500 dark:text-gray-400">
                              {user.email}
                            </div>
                            {user.enrollment_number && (
                              <div className="text-xs text-gray-500 dark:text-gray-400">
                                Enrollment: {user.enrollment_number}
                              </div>
                            )}
                          </div>
                        </div>
                        <div className="flex items-center space-x-4">
                           {/* Registration Details */}
                          {user.registrations && user.registrations.length > 0 && (
                            <div className="flex flex-col items-end">
                               <div className="text-sm text-gray-500 dark:text-gray-400 mb-2">
                                Registrations: {user.registrations.length}
                              </div>
                               
                               {/* Registration Details */}
                               <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 max-w-md">
                                 <div className="text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">
                                   Selected Items:
                                 </div>
                                 <div className="space-y-1">
                                                                      {user.registrations.map(reg => {
                                     let itemName = '';
                                     let itemPrice = 0;
                                     
                                     if (reg.target_type === 'event' && reg.events) {
                                       itemName = reg.events.name;
                                       itemPrice = reg.events.price || 0;
                                     } else if (reg.target_type === 'workshop' && reg.workshops) {
                                       itemName = reg.workshops.title;
                                       itemPrice = reg.workshops.fee || 0;
                                     } else if (reg.target_type === 'combo' && reg.combos) {
                                       itemName = reg.combos.name;
                                       itemPrice = reg.combos.price || 0;
                                     } else {
                                       // Fallback when nested data is not available
                                       if (reg.target_type === 'event') {
                                         const event = events.find(e => e.id === reg.target_id);
                                         if (event) {
                                           itemName = event.name;
                                           itemPrice = event.price || 0;
                                         } else {
                                           itemName = `Event ${reg.target_id}`;
                                           itemPrice = 0;
                                         }
                                       } else if (reg.target_type === 'workshop') {
                                         const workshop = workshops.find(w => w.id === reg.target_id);
                                         if (workshop) {
                                           itemName = workshop.title;
                                           itemPrice = workshop.fee || 0;
                                         } else {
                                           itemName = `Workshop ${reg.target_id}`;
                                           itemPrice = 0;
                                         }
                                       } else if (reg.target_type === 'combo') {
                                         const combo = combos.find(c => c.id === reg.target_id);
                                         if (combo) {
                                           itemName = combo.name;
                                           itemPrice = combo.price || 0;
                                         } else {
                                           itemName = `Combo ${reg.target_id}`;
                                           itemPrice = 0;
                                         }
                                       }
                                     }
                                     
                                     return (
                                       <div key={reg.id} className="flex justify-between items-center text-xs">
                                         <div className="flex-1">
                                           <span className="text-gray-900 dark:text-white font-medium">
                                             {itemName}
                                           </span>
                                           <span className="text-gray-500 dark:text-gray-400 ml-1">
                                             ({reg.target_type})
                                           </span>
                                         </div>
                                         <div className="flex items-center space-x-2">
                                           <span className="text-gray-600 dark:text-gray-300">
                                             ₹{reg.amount_paid || 0}
                                           </span>
                                           <div className="flex space-x-1">
                                    <button
                                      onClick={() => handleUpdatePaymentStatus(reg.id, 'approved')}
                                               className={`p-1 rounded ${reg.payment_status === 'approved' ? 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300' : 'text-gray-400 hover:text-green-600 dark:hover:text-green-300'}`}
                                      title="Approve Payment"
                                    >
                                               <Check className="h-3 w-3" />
                                    </button>
                                    <button
                                      onClick={() => handleUpdatePaymentStatus(reg.id, 'declined')}
                                               className={`p-1 rounded ${reg.payment_status === 'declined' ? 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300' : 'text-gray-400 hover:text-red-600 dark:hover:text-red-300'}`}
                                      title="Decline Payment"
                                    >
                                               <X className="h-3 w-3" />
                                    </button>
                                    <button
                                      onClick={() => handleUpdatePaymentStatus(reg.id, 'pending')}
                                               className={`p-1 rounded ${reg.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900 dark:text-yellow-300' : 'text-gray-400 hover:text-yellow-600 dark:hover:text-yellow-300'}`}
                                      title="Mark as Pending"
                                    >
                                               <DollarSign className="h-3 w-3" />
                                    </button>
                                  </div>
                                         </div>
                                       </div>
                                     );
                                   })}
                                 </div>
                                 
                                 {/* Transaction Summary */}
                                 {user.registrations.length > 0 && (
                                   <div className="border-t pt-2 mt-2">
                                     <div className="flex justify-between text-xs font-medium">
                                       <span className="text-gray-700 dark:text-gray-300">Transaction ID:</span>
                                       <span className="text-gray-900 dark:text-white">
                                         {user.registrations[0]?.transaction_id || 'N/A'}
                                       </span>
                                     </div>
                                     <div className="flex justify-between text-xs font-medium mt-1">
                                       <span className="text-gray-700 dark:text-gray-300">Total Paid:</span>
                                       <span className="text-green-600 dark:text-green-400">
                                         ₹{user.registrations.reduce((sum, reg) => sum + (reg.amount_paid || 0), 0).toFixed(2)}
                                       </span>
                                     </div>
                                   </div>
                                 )}
                              </div>
                            </div>
                          )}
                          
                          {/* User Actions */}
                          <div className="flex space-x-2">
                            <button
                              onClick={() => handleEditUser(user)}
                              className="p-2 rounded-md text-gray-500 hover:text-indigo-600 dark:text-gray-400 dark:hover:text-indigo-400"
                              title="Edit User"
                            >
                              <Edit className="h-5 w-5" />
                            </button>
                            <button
                              onClick={() => handleDeleteUser(user.id)}
                              className="p-2 rounded-md text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400"
                              title="Delete User"
                            >
                              <Trash2 className="h-5 w-5" />
                            </button>
                          </div>
                        </div>
                      </div>
                    </li>
                  ))
                ) : (
                  <li className="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                    No users found. Try adjusting your search or filter.
                  </li>
                )}
              </ul>
            </div>
          )}

          {/* Event Management Tab */}
          {activeTab === 'events' && (
            <div className="space-y-6">
              {/* Events Section */}
              <div>
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">Events</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {events.length > 0 ? (
                events.map(event => (
                  <div key={event.id} className="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div className="p-5">
                      <div className="flex justify-between">
                        <div className="font-bold text-xl mb-2 text-gray-900 dark:text-white">{event.name}</div>
                        <div className={`px-2 py-1 text-xs rounded-full ${event.is_active ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>
                          {event.is_active ? 'Active' : 'Inactive'}
                        </div>
                      </div>
                      <p className="text-gray-700 dark:text-gray-300 text-sm mb-4">
                        {event.description ? (
                          event.description.length > 100 ? 
                            `${event.description.substring(0, 100)}...` : 
                            event.description
                        ) : 'No description available'}
                      </p>
                      <div className="flex justify-between items-center">
                        <div className="text-sm text-gray-500 dark:text-gray-400">
                          <div>Price: ₹{event.price}</div>
                          <div>Category: {event.category === 'tech' ? 'Technical' : 'Non-Technical'}</div>
                          <div>Registrations: {event.registrations ? event.registrations.length : 0}</div>
                        </div>
                        <button
                          onClick={() => handleViewEventParticipants(event.id)}
                          className="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-900 dark:text-indigo-200 dark:hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        >
                          <Eye className="-ml-0.5 mr-2 h-4 w-4" />
                          View Participants
                        </button>
                      </div>
                    </div>
                  </div>
                ))
              ) : (
                <div className="col-span-full text-center text-gray-500 dark:text-gray-400 py-12">
                      No events found.
                </div>
              )}
                </div>
              </div>

              {/* Workshops Section */}
              <div>
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">Workshops</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {workshops.length > 0 ? (
                    workshops.map(workshop => (
                      <div key={workshop.id} className="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                        <div className="p-5">
                          <div className="flex justify-between">
                            <div className="font-bold text-xl mb-2 text-gray-900 dark:text-white">{workshop.title}</div>
                            <div className={`px-2 py-1 text-xs rounded-full ${workshop.is_active ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>
                              {workshop.is_active ? 'Active' : 'Inactive'}
                            </div>
                          </div>
                          <p className="text-gray-700 dark:text-gray-300 text-sm mb-4">
                            {workshop.description ? (
                              workshop.description.length > 100 ? 
                                `${workshop.description.substring(0, 100)}...` : 
                                workshop.description
                            ) : 'No description available'}
                          </p>
                                                     <div className="flex justify-between items-center">
                             <div className="text-sm text-gray-500 dark:text-gray-400">
                               <div>Fee: ₹{workshop.fee || 0}</div>
                               <div>Capacity: {workshop.capacity || 'Unlimited'}</div>
                               <div>Duration: {workshop.start_time && workshop.end_time ? `${workshop.start_time} - ${workshop.end_time}` : 'TBD'}</div>
                               <div>Registrations: {workshop.registrations ? workshop.registrations.length : 0}</div>
                             </div>
                             <div className="flex items-center space-x-2">
                               <button
                                 onClick={() => handleViewWorkshopParticipants(workshop.id)}
                                 className="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-purple-700 bg-purple-100 hover:bg-purple-200 dark:bg-purple-900 dark:text-purple-200 dark:hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
                               >
                                 <Eye className="-ml-0.5 mr-2 h-4 w-4" />
                                 View Participants
                               </button>
                               <div className="px-3 py-1 text-xs rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">
                                 Workshop
                               </div>
                             </div>
                           </div>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="col-span-full text-center text-gray-500 dark:text-gray-400 py-12">
                      No workshops found.
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Event Participants Tab */}
          {activeTab === 'eventParticipants' && selectedEvent && (
            <div className="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
              <div className="px-4 py-5 sm:px-6">
                <h3 className="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                  Participants for: {selectedEvent.name}
                </h3>
                <p className="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
                  Total Registrations: {registrations.length}
                </p>
              </div>
              <div className="border-t border-gray-200 dark:border-gray-700">
                <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                  <thead className="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Name
                      </th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Email
                      </th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Enrollment
                      </th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Registration Type
                      </th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Payment Status
                      </th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {registrations.length > 0 ? (
                      registrations.map(reg => (
                        <tr key={reg.id}>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center">
                              <div className="flex-shrink-0 h-10 w-10">
                                {reg.users.photo_url ? (
                                  <img className="h-10 w-10 rounded-full" src={reg.users.photo_url} alt="" />
                                ) : (
                                  <div className="h-10 w-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
                                    <span className="text-gray-600 dark:text-gray-300 text-sm font-medium">
                                      {reg.users.name.charAt(0).toUpperCase()}
                                    </span>
                                  </div>
                                )}
                              </div>
                              <div className="ml-4">
                                <div className="text-sm font-medium text-gray-900 dark:text-white">
                                  {reg.users.name}
                                </div>
                                <div className="text-sm text-gray-500 dark:text-gray-400">
                                  {reg.users.phone}
                                </div>
                              </div>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {reg.users.email}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {reg.users.enrollment_number || '-'}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              reg.registrationType === 'Combo' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' :
                              'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                            }`}>
                              {reg.registrationType || 'Direct'}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              reg.payment_status === 'approved' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                              reg.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                              reg.payment_status === 'declined' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                              'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                            }`}>
                              {reg.payment_status.charAt(0).toUpperCase() + reg.payment_status.slice(1)}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div className="flex space-x-2">
                              <button
                                onClick={() => handleUpdatePaymentStatus(reg.id, 'approved')}
                                className={`p-1 rounded-md ${reg.payment_status === 'approved' ? 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300' : 'text-gray-400 hover:text-green-600 dark:hover:text-green-300'}`}
                                title="Approve Payment"
                              >
                                <Check className="h-4 w-4" />
                              </button>
                              <button
                                onClick={() => handleUpdatePaymentStatus(reg.id, 'declined')}
                                className={`p-1 rounded-md ${reg.payment_status === 'declined' ? 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300' : 'text-gray-400 hover:text-red-600 dark:hover:text-red-300'}`}
                                title="Decline Payment"
                              >
                                <X className="h-4 w-4" />
                              </button>
                              <button
                                onClick={() => handleUpdatePaymentStatus(reg.id, 'pending')}
                                className={`p-1 rounded-md ${reg.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900 dark:text-yellow-300' : 'text-gray-400 hover:text-yellow-600 dark:hover:text-yellow-300'}`}
                                title="Mark as Pending"
                              >
                                <DollarSign className="h-4 w-4" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="6" className="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                          No participants found for this event.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Attendance / Scanner Tab */}
          {activeTab === 'attendance' && (
            <div className="space-y-6">
              {/* Target selection: Tech / Non-Tech events and Workshops */}
              <div className="card p-4">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">Select targets to monitor</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div>
                    <h4 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Technical Events</h4>
                    <div className="space-y-2 max-h-56 overflow-y-auto">
                      {events.filter(e => e.category === 'tech').map(event => {
                        const selected = selectedTarget && selectedTarget.id === event.id && selectedTarget.type === 'event'
                        return (
                          <label key={event.id} className="flex items-center space-x-2 text-sm">
                            <input 
                              type="radio" 
                              name="tech_event"
                              checked={selected} 
                              onChange={() => {
                                console.log(`Tech event ${event.name} selected`)
                                setSelectedTarget({ id: event.id, type: 'event', name: event.name })
                                setScannerSelectedTargets([{ id: event.id, type: 'event' }])
                              }} 
                            />
                            <span>{event.name}</span>
                          </label>
                        )
                      })}
                    </div>
                  </div>
                  <div>
                    <h4 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Non-Technical Events</h4>
                    <div className="space-y-2 max-h-56 overflow-y-auto">
                      {events.filter(e => e.category === 'non-tech').map(event => {
                        const selected = selectedTarget && selectedTarget.id === event.id && selectedTarget.type === 'event'
                        return (
                          <label key={event.id} className="flex items-center space-x-2 text-sm">
                            <input 
                              type="radio" 
                              name="non_tech_event"
                              checked={selected} 
                              onChange={() => {
                                console.log(`Non-tech event ${event.name} selected`)
                                setSelectedTarget({ id: event.id, type: 'event', name: event.name })
                                setScannerSelectedTargets([{ id: event.id, type: 'event' }])
                              }} 
                            />
                            <span>{event.name}</span>
                          </label>
                        )
                      })}
                    </div>
                  </div>
                  <div>
                    <h4 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Workshops</h4>
                    <div className="space-y-2 max-h-56 overflow-y-auto">
                      {workshops.map(workshop => {
                        const selected = selectedTarget && selectedTarget.id === workshop.id && selectedTarget.type === 'workshop'
                        return (
                          <label key={workshop.id} className="flex items-center space-x-2 text-sm">
                            <input 
                              type="radio" 
                              name="workshop"
                              checked={selected} 
                              onChange={() => {
                                console.log(`Workshop ${workshop.title} selected`)
                                setSelectedTarget({ id: workshop.id, type: 'workshop', name: workshop.title })
                                setScannerSelectedTargets([{ id: workshop.id, type: 'workshop' }])
                              }} 
                            />
                            <span>{workshop.title}</span>
                          </label>
                        )
                      })}
                    </div>
                  </div>
                </div>
              </div>

              {/* Live participant list */}
              <div className="card p-4">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white">Live Participants</h3>
                  <button onClick={() => refreshScannerParticipants()} className="btn-secondary">Refresh</button>
                          </div>
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead className="bg-gray-50 dark:bg-gray-800">
                      <tr>
                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Name</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Email</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Phone</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Target</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Attended</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Time</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                      {scannerAttendanceLogs.map(row => (
                        <tr key={`${row.user_id}-${row.target_type}-${row.target_id}`}>
                          <td className="px-4 py-2 text-sm text-gray-900 dark:text-white">{row.name}</td>
                          <td className="px-4 py-2 text-sm text-gray-500">{row.email}</td>
                          <td className="px-4 py-2 text-sm text-gray-500">{row.phone || '-'}</td>
                          <td className="px-4 py-2 text-sm text-gray-500">{row.targetName}</td>
                          <td className="px-4 py-2 text-sm">
                            {row.attended ? (
                              <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Yes</span>
                            ) : (
                              <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>
                            )}
                          </td>
                          <td className="px-4 py-2 text-sm text-gray-500">{row.time || '-'}</td>
                        </tr>
                      ))}
                      {scannerAttendanceLogs.length === 0 && (
                        <tr>
                          <td className="px-4 py-6 text-center text-gray-500 dark:text-gray-400" colSpan="6">Select targets to view participants</td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Start Scanning Button */}
              <div className="card p-4">
                <div className="flex items-center justify-center space-x-4">
                  <button
                    onClick={() => {
                      console.log('Start Scanning clicked. Current target:', selectedTarget)
                      startScanning()
                    }}
                    disabled={!selectedTarget}
                    className={`btn-primary flex items-center space-x-2 ${
                      !selectedTarget 
                        ? 'opacity-50 cursor-not-allowed' 
                        : 'hover:bg-indigo-700'
                    }`}
                  >
                    <QrCode className="h-5 w-5" />
                    <span>Start Scanning</span>
                  </button>
                  
                  {selectedTarget && (
                    <button
                      onClick={() => {
                        setSelectedTarget(null)
                        setScannerSelectedTargets([])
                        setScannerAttendanceLogs([])
                      }}
                      className="btn-secondary"
                    >
                      Clear Selection
                    </button>
                  )}
                </div>
                <div className="text-center mt-3">
                  {!selectedTarget ? (
                    <p className="text-sm text-gray-500 dark:text-gray-400">
                      Select one target to start scanning
                    </p>
                  ) : (
                    <p className="text-sm text-green-600 dark:text-green-400 font-medium">
                      ✓ Target selected: {selectedTarget.name}
                    </p>
                  )}
                </div>
              </div>
            </div>
          )}
        </>
      )}

      {/* User Modal */}
      {showUserModal && (
        <div className="fixed z-10 inset-0 overflow-y-auto">
          <div className="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div className="fixed inset-0 transition-opacity" aria-hidden="true">
              <div className="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-900 dark:opacity-75"></div>
            </div>
            <span className="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div className="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              <form onSubmit={handleUserSubmit}>
                <div className="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                  <div className="sm:flex sm:items-start">
                    <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                             <div className="flex justify-between items-center">
                      <h3 className="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                        {editingUser ? 'Edit User' : 'Add New User'}
                      </h3>
                         <button
                           type="button"
                           onClick={() => {
                             setUserFormData(prev => ({
                               ...prev,
                               selected_tech_events: [],
                               selected_non_tech_events: [],
                               selected_workshops: [],
                               selected_combos: []
                             }));
                           }}
                           className="text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                         >
                           Clear All Selections
                         </button>
                                                </div>
                         
                         {/* Selection Summary */}
                         {(userFormData.selected_tech_events.length > 0 || 
                           userFormData.selected_non_tech_events.length > 0 || 
                           userFormData.selected_workshops.length > 0 || 
                           userFormData.selected_combos.length > 0) && (
                           <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-md border border-blue-200 dark:border-blue-800">
                             <div className="flex justify-between items-center text-sm">
                               <span className="text-blue-800 dark:text-blue-200 font-medium">
                                 Selected Items Summary:
                               </span>
                               <span className="text-blue-600 dark:text-blue-400">
                                 {userFormData.selected_tech_events.length + 
                                  userFormData.selected_non_tech_events.length + 
                                  userFormData.selected_workshops.length + 
                                  userFormData.selected_combos.length} items
                               </span>
                             </div>
                             <div className="mt-2 flex flex-wrap gap-2 text-xs">
                               {userFormData.selected_tech_events.length > 0 && (
                                 <span className="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded">
                                   {userFormData.selected_tech_events.length} Tech Events
                                 </span>
                               )}
                               {userFormData.selected_non_tech_events.length > 0 && (
                                 <span className="px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded">
                                   {userFormData.selected_non_tech_events.length} Non-Tech Events
                                 </span>
                               )}
                               {userFormData.selected_workshops.length > 0 && (
                                 <span className="px-2 py-1 bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 rounded">
                                   {userFormData.selected_workshops.length} Workshops
                                 </span>
                               )}
                               {userFormData.selected_combos.length > 0 && (
                                 <span className="px-2 py-1 bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200 rounded">
                                   {userFormData.selected_combos.length} Combos
                                 </span>
                               )}
                             </div>
                           </div>
                         )}
                         
                      <div className="mt-4 space-y-4">
                        <div>
                          <label htmlFor="name" className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Name
                          </label>
                          <input
                            type="text"
                            name="name"
                            id="name"
                            required
                            value={userFormData.name}
                            onChange={handleUserFormChange}
                            className="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                          />
                        </div>
                        <div>
                          <label htmlFor="email" className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Email
                          </label>
                           <div className="relative">
                          <input
                            type="email"
                            name="email"
                            id="email"
                            required
                            value={userFormData.email}
                            onChange={handleUserFormChange}
                               className={`mt-1 block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white ${
                                 validationErrors.email 
                                   ? 'border-red-300 dark:border-red-600' 
                                   : 'border-gray-300 dark:border-gray-600'
                               }`}
                             />
                             {isValidating.email && (
                               <div className="absolute inset-y-0 right-0 flex items-center pr-3">
                                 <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-500"></div>
                               </div>
                             )}
                           </div>
                           {validationErrors.email && (
                             <p className="mt-1 text-sm text-red-600 dark:text-red-400">
                               {validationErrors.email}
                             </p>
                           )}
                        </div>
                        <div>
                          <label htmlFor="phone" className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Phone
                          </label>
                           <div className="relative">
                          <input
                            type="text"
                            name="phone"
                            id="phone"
                            value={userFormData.phone || ''}
                            onChange={handleUserFormChange}
                               className={`mt-1 block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white ${
                                 validationErrors.phone 
                                   ? 'border-red-300 dark:border-red-600' 
                                   : 'border-gray-300 dark:border-gray-600'
                               }`}
                             />
                             {isValidating.phone && (
                               <div className="absolute inset-y-0 right-0 flex items-center pr-3">
                                 <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-500"></div>
                               </div>
                             )}
                           </div>
                           {validationErrors.phone && (
                             <p className="mt-1 text-sm text-red-600 dark:text-red-400">
                               {validationErrors.phone}
                             </p>
                           )}
                        </div>
                        <div>
                          <label htmlFor="enrollment_number" className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enrollment Number
                          </label>
                          <input
                            type="text"
                            name="enrollment_number"
                            id="enrollment_number"
                            value={userFormData.enrollment_number || ''}
                            onChange={handleUserFormChange}
                            className="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                          />
                        </div>
                        <div>
                          <label htmlFor="college_id" className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            College
                          </label>
                          <select
                            name="college_id"
                            id="college_id"
                            value={userFormData.college_id || ''}
                            onChange={handleUserFormChange}
                            className="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                          >
                            <option value="">Select College</option>
                            {colleges.map(college => (
                              <option key={college.id} value={college.id}>{college.name}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label htmlFor="semester" className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Semester
                          </label>
                          <input
                            type="text"
                            name="semester"
                            id="semester"
                            value={userFormData.semester || ''}
                            onChange={handleUserFormChange}
                            className="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                          />
                        </div>
                        <div>
                          <label htmlFor="field_id" className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Field
                          </label>
                          <select
                            name="field_id"
                            id="field_id"
                            value={userFormData.field_id || ''}
                            onChange={handleUserFormChange}
                            className="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                          >
                            <option value="">Select Field</option>
                            {fields.map(field => (
                              <option key={field.id} value={field.id}>{field.name}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                           <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Technical Events ({userFormData.selected_tech_events.length} selected)
                          </label>
                           <div className="mt-1 max-h-48 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-md p-3 bg-gray-50 dark:bg-gray-800">
                            {events.filter(e => e.category === 'tech').map(event => {
                              const isDisabled = isEventInSelectedCombo(event.id);
                              return (
                                <label key={event.id} className={`flex items-center space-x-3 py-2 rounded px-2 ${isDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer'}`}>
                                  <input
                                    type="checkbox"
                                    checked={userFormData.selected_tech_events.includes(event.id)}
                                    onChange={(e) => handleCheckboxChange('selected_tech_events', event.id, e.target.checked)}
                                    disabled={isDisabled}
                                    className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                  />
                                  {isDisabled && (
                                    <span className="text-xs text-gray-500 dark:text-gray-400 ml-2">
                                      (Part of selected combo)
                                    </span>
                                  )}
                                  <div className="flex-1">
                                    <span className="text-sm font-medium text-gray-900 dark:text-white">
                                      {event.name}
                                    </span>
                                    <span className="text-sm text-gray-500 dark:text-gray-400 ml-2">
                                      ₹{event.price || 0}
                                    </span>
                                  </div>
                                </label>
                              );
                            })}
                             {events.filter(e => e.category === 'tech').length === 0 && (
                               <p className="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
                                 No technical events available
                               </p>
                             )}
                           </div>
                           {userFormData.selected_tech_events.length > 0 && (
                             <button
                               type="button"
                               onClick={() => setUserFormData(prev => ({ ...prev, selected_tech_events: [] }))}
                               className="mt-2 text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
                             >
                               Clear All
                             </button>
                           )}
                        </div>
                        <div>
                           <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Non-Technical Events ({userFormData.selected_non_tech_events.length} selected)
                          </label>
                           <div className="mt-1 max-h-48 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-md p-3 bg-gray-50 dark:bg-gray-800">
                            {events.filter(e => e.category === 'non-tech').map(event => {
                              const isDisabled = isEventInSelectedCombo(event.id);
                              return (
                                <label key={event.id} className={`flex items-center space-x-3 py-2 rounded px-2 ${isDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer'}`}>
                                  <input
                                    type="checkbox"
                                    checked={userFormData.selected_non_tech_events.includes(event.id)}
                                    onChange={(e) => handleCheckboxChange('selected_non_tech_events', event.id, e.target.checked)}
                                    disabled={isDisabled}
                                    className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                  />
                                  {isDisabled && (
                                    <span className="text-xs text-gray-500 dark:text-gray-400 ml-2">
                                      (Part of selected combo)
                                    </span>
                                  )}
                                  <div className="flex-1">
                                    <span className="text-sm font-medium text-gray-900 dark:text-white">
                                      {event.name}
                                    </span>
                                    <span className="text-sm text-gray-500 dark:text-gray-400 ml-2">
                                      ₹{event.price || 0}
                                    </span>
                                  </div>
                                </label>
                              );
                            })}
                             {events.filter(e => e.category === 'non-tech').length === 0 && (
                               <p className="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
                                 No non-technical events available
                               </p>
                             )}
                           </div>
                           {userFormData.selected_non_tech_events.length > 0 && (
                             <button
                               type="button"
                               onClick={() => setUserFormData(prev => ({ ...prev, selected_non_tech_events: [] }))}
                               className="mt-2 text-xs text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300"
                             >
                               Clear All
                             </button>
                           )}
                        </div>
                        <div>
                           <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Workshops ({userFormData.selected_workshops.length} selected)
                          </label>
                           <div className="mt-1 max-h-48 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-md p-3 bg-gray-50 dark:bg-gray-800">
                            {workshops.map(workshop => {
                              const isDisabled = isWorkshopInSelectedCombo(workshop.id);
                              return (
                                <label key={workshop.id} className={`flex items-center space-x-3 py-2 rounded px-2 ${isDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer'}`}>
                                  <input
                                    type="checkbox"
                                    checked={userFormData.selected_workshops.includes(workshop.id)}
                                    onChange={(e) => handleCheckboxChange('selected_workshops', workshop.id, e.target.checked)}
                                    disabled={isDisabled}
                                    className="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                  />
                                  {isDisabled && (
                                    <span className="text-xs text-gray-500 dark:text-gray-400 ml-2">
                                      (Part of selected combo)
                                    </span>
                                  )}
                                  <div className="flex-1">
                                    <span className="text-sm font-medium text-gray-900 dark:text-white">
                                      {workshop.name}
                                    </span>
                                    <span className="text-sm text-gray-500 dark:text-gray-400 ml-2">
                                      ₹{workshop.price || 0}
                                    </span>
                                  </div>
                                </label>
                              );
                            })}
                            {workshops.length === 0 && (
                              <p className="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
                                No workshops available
                              </p>
                            )}
                          </div>
                          {userFormData.selected_workshops.length > 0 && (
                            <button
                              type="button"
                              onClick={() => setUserFormData(prev => ({ ...prev, selected_workshops: [] }))}
                              className="mt-2 text-xs text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300"
                            >
                              Clear All
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          )}
        </div>
      </div>
    </div>
    </>
  );
}

export default RegistrationCoordinator;